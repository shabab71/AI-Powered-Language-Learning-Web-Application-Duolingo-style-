{% load static %}
<!doctype html>
<html lang="en" data-bs-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>LinguaLearn â€” Vocabulary</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Custom Styles -->
  <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
</head>

<body>
  <!-- Top Navbar -->
  <nav class="navbar app-nav py-2">
    <div class="container-fluid px-3">
      <div class="d-flex align-items-center gap-2">
        <button class="btn icon-btn d-lg-none" id="menuBtn"><i class="bi bi-list"></i></button>
        <div class="brand-pill px-3 py-1"><a href="{% url 'lessons:dashboard' %}" class="fw-bold text-black">LinguaLearn</a></div>
      </div>
      <div class="ms-auto d-flex align-items-center gap-2">
        <button id="themeBtn" class="btn icon-btn"><i class="bi bi-sun-fill theme-sun"></i><i class="bi bi-moon-stars-fill d-none theme-moon"></i></button>
        <div class="dropdown">
          <button class="nav-avatar-btn d-flex align-items-center gap-2" data-bs-toggle="dropdown">
            <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="Profile" class="avatar">
            <i class="bi bi-caret-down-fill small"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><h6 class="dropdown-header">Hi, {{ user.first_name|default:"User" }}</h6></li>
            <li><a class="dropdown-item" href="{% url 'lessons:dashboard' %}"><i class="bi bi-house me-2"></i>Dashboard</a></li>
            <li><a class="dropdown-item" href="{% url 'lessons:logout_user' %}"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
          </ul>
        </div>
      </div>
    </div>
  </nav>

  <div class="d-flex">
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar p-3">
      <nav class="d-grid gap-2" aria-label="Primary">
        <a class="btn side-link text-start" href="{% url 'lessons:dashboard' %}"><i class="bi bi-house me-2"></i> Dashboard</a>
        <a class="btn side-link text-start" href="{% url 'lessons:lessons' %}"><i class="bi bi-mortarboard me-2"></i> Lessons</a>
        <a class="btn side-link active text-start" href="{% url 'lessons:vocabulary' %}"><i class="bi bi-diagram-3 me-2"></i> Vocabulary</a>
        <a class="btn side-link text-start" href="#"><i class="bi bi-journal-bookmark me-2"></i> Journals</a>
        <a class="btn side-link text-start" href="#"><i class="bi bi-question-circle me-2"></i> Quizzes</a>
        <a class="btn side-link text-start" href="#"><i class="bi bi-graph-up me-2"></i> Progress</a>
        <a class="btn side-link text-start" href="#"><i class="bi bi-life-preserver me-2"></i> Help</a>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-grow-1 p-3 p-md-4 p-lg-5" style="max-width:1625px;">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="section-title mb-0">Vocabulary List</h2>
        <input type="search" id="searchBox" class="form-control w-auto" placeholder="Search words..." style="max-width:300px;">
      </div>

      <!-- Filter -->
      <div class="row mb-4">
        <div class="col-md-3">
          <select id="difficultyFilter" class="form-select">
            <option value="all">All Difficulties</option>
            <option value="easy">Easy</option>
            <option value="medium">Medium</option>
            <option value="hard">Hard</option>
          </select>
        </div>
      </div>

      <!-- Words Grid -->
      <section class="row g-4" id="wordGrid">
        {% for w in words %}
        <div class="col-md-4 col-lg-3 word-card" data-name="{{ w.english|lower }}" data-diff="{{ w.difficulty }}">
          <div class="card h-100 p-3 text-center {% if w.id in learned_ids %}border-success-subtle{% endif %}">
            {% if w.banner %}
              <img src="{{ w.banner.url }}" alt="{{ w.english }}" class="mb-3 rounded" style="height:150px;object-fit:cover;width:100%;">
            {% endif %}

            <h5 class="fw-semibold mb-1">{{ w.english }}</h5>
            <div class="text-secondary mb-2">{{ w.hindi }}</div>
            <p class="small mb-2">{{ w.description|default:"No description available." }}</p>
            <span class="badge bg-light text-dark border mb-2">{{ w.get_difficulty_display }}</span>

            <!-- âœ… Audio + Video Buttons -->
            <div class="d-flex justify-content-center gap-2 mb-3">
              {% if w.hindi_audio %}
                <audio id="hindiAudio{{ w.id }}" src="{{ w.hindi_audio.url }}"></audio>
                <button class="btn btn-outline btn-sm" onclick="playAudio('hindiAudio{{ w.id }}')">ðŸ”Š Hindi</button>
              {% endif %}
              {% if w.english_audio %}
                <audio id="englishAudio{{ w.id }}" src="{{ w.english_audio.url }}"></audio>
                <button class="btn btn-outline btn-sm" onclick="playAudio('englishAudio{{ w.id }}')">ðŸ”Š English</button>
              {% endif %}
              {% if w.video %}
                <button class="btn btn-outline btn-sm" onclick="openVideo('{{ w.video.url }}','{{ w.english }}')">
                  <i class="bi bi-camera-video"></i>
                </button>
              {% endif %}
            </div>

            <div class="d-grid">
              {% if w.id in learned_ids %}
                <button class="btn btn-success btn-sm disabled"><i class="bi bi-check-circle"></i> Learned</button>
              {% else %}
                <button class="btn btn-accent btn-sm learn-btn" data-id="{{ w.id }}">
                  <i class="bi bi-lightning-charge"></i> Mark Learned
                </button>
              {% endif %}
            </div>
          </div>
        </div>
        {% empty %}
        <p class="text-center text-secondary">No words available yet.</p>
        {% endfor %}
      </section>
    </main>
  </div>

  <!-- Video Modal -->
  <div class="modal fade" id="videoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content rounded-4">
        <div class="modal-header border-0">
          <h5 class="modal-title" id="videoTitle"></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center">
          <video id="videoPlayer" class="w-100 rounded" controls></video>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="mt-0">
    <div class="container-fluid py-3 px-4 small d-flex justify-content-between">
      <span>Â© <span id="year"></span> LinguaLearn. All rights reserved.</span>
      <a href="#">Contact support</a>
    </div>
  </footer>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Year
    document.getElementById('year').textContent = new Date().getFullYear();

    // Theme toggle
    const root = document.documentElement;
    const themeBtn = document.getElementById('themeBtn');
    const setTheme = t => {
      root.setAttribute('data-bs-theme', t);
      document.querySelector('.theme-sun').classList.toggle('d-none', t==='dark');
      document.querySelector('.theme-moon').classList.toggle('d-none', t!=='dark');
      localStorage.setItem('theme', t);
    };
    setTheme(localStorage.getItem('theme') || 'light');
    themeBtn.addEventListener('click', ()=> {
      const next = root.getAttribute('data-bs-theme')==='light' ? 'dark' : 'light';
      setTheme(next);
    });

    // Audio player
    function playAudio(id){
      const a = document.getElementById(id);
      if(a){ a.currentTime = 0; a.play(); }
    }

    // Open video modal
    function openVideo(src, title){
      const player = document.getElementById('videoPlayer');
      const modal = new bootstrap.Modal(document.getElementById('videoModal'));
      document.getElementById('videoTitle').textContent = title;
      player.src = src;
      modal.show();
    }

    // Learn button AJAX
    document.querySelectorAll('.learn-btn').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const id = btn.dataset.id;
        const res = await fetch("{% url 'lessons:mark_word_learned' 0 %}".replace('/0/', `/${id}/`));
        if(res.ok){
          btn.classList.remove('btn-accent');
          btn.classList.add('btn-success','disabled');
          btn.innerHTML = '<i class="bi bi-check-circle"></i> Learned';
        }
      });
    });

    // âœ… Search & Filter Functionality
    const searchBox = document.getElementById('searchBox');
    const difficultyFilter = document.getElementById('difficultyFilter');
    const cards = document.querySelectorAll('.word-card');

    function filterWords(){
      const query = searchBox.value.toLowerCase();
      const level = difficultyFilter.value;

      cards.forEach(card => {
        const name = card.dataset.name;
        const diff = card.dataset.diff;
        const visible =
          (level === 'all' || diff === level) &&
          (query === '' || name.includes(query));
        card.style.display = visible ? '' : 'none';
      });
    }

    searchBox.addEventListener('input', filterWords);
    difficultyFilter.addEventListener('change', filterWords);
  </script>
</body>
</html>
